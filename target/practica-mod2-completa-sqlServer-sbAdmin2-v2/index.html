<!DOCTYPE html>
<html lang="en">

<head>

    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta name="description" content="">
    <meta name="author" content="">

    <title>SB Admin 2 - Login</title>

    <!-- Custom fonts for this template-->
    <link href="vendor/fontawesome-free/css/all.min.css" rel="stylesheet" type="text/css">
    <link
        href="https://fonts.googleapis.com/css?family=Nunito:200,200i,300,300i,400,400i,600,600i,700,700i,800,800i,900,900i"
        rel="stylesheet">

    <!-- Custom styles for this template-->
    <link href="css/sb-admin-2.min.css" rel="stylesheet">






    <!-- LOGIN GOOGLE-->
    <script src="https://accounts.google.com/gsi/client" async defer></script>
</head>

<body class="bg-gradient-primary">

    <div class="container">

        <!-- Outer Row -->
        <div class="row justify-content-center">

            <div class="col-xl-10 col-lg-12 col-md-9">

                <div class="card o-hidden border-0 shadow-lg my-5">
                    <div class="card-body p-0">
                        <!-- Nested Row within Card Body -->
                        <div class="row">
                            <div class="col-lg-6 d-none d-lg-block bg-login-image"></div>
                            <div class="col-lg-6">
                                <div class="p-5">
                                    <div class="text-center">
                                        <h1 class="h4 text-gray-900 mb-4">Welcome Back!</h1>
                                    </div>
                                    <form class="user">
                                        <div class="form-group">
                                            <input type="text" class="form-control form-control-user" id="txtLogin"
                                                aria-describedby="emailHelp" placeholder="Ingrese el txtLogin">
                                        </div>
                                        <div class="form-group">
                                            <input type="password" class="form-control form-control-user" id="txtPass"
                                                placeholder="Password">
                                        </div>

                                        <button type="button" class="btn btn-primary" id="btnLogin">Login</button>
                                        <hr>


                                        <!-- BOTON LOGIN GOOGLE-->
                                        <div class="card-footer text-center py-3">

                                            <div id="g_id_onload"
                                                data-client_id="914158457144-qd1sdimd2ntcmf9krft1rgqafdlsh2bg.apps.googleusercontent.com"
                                                data-auto_prompt="false">
                                            </div>

                                            <div class="g_id_signin" data-type="standard" data-shape="rectangular"
                                                data-theme="outline" data-text="sign_in_with" data-size="large"
                                                data-logo_alignment="left">
                                            </div>

                                        </div>
                                        <!-- BOTON LOGIN GOOGLE-->


                                        <!-- BOTON LOGIN FACEBOOK -->
                                        <div class="card-footer text-center py-3">
                                            <fb:login-button scope="public_profile,email" onlogin="checkLoginState();">
                                            </fb:login-button>
                                        </div>
                                        <!-- BOTON LOGIN FACEBOOK  -->
                                    </form>
                                    <hr>
                                    <div class="text-center">
                                        <a class="small" href="forgot-password.html">Forgot Password?</a>
                                    </div>
                                    <div class="text-center">
                                        <a class="small" href="register.html">Create an Account!</a>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

            </div>

        </div>

    </div>

    <!-- Bootstrap core JavaScript-->
    <script src="vendor/jquery/jquery.min.js"></script>
    <script src="vendor/bootstrap/js/bootstrap.bundle.min.js"></script>

    <!-- Core plugin JavaScript-->
    <script src="vendor/jquery-easing/jquery.easing.min.js"></script>

    <!-- Custom scripts for all pages-->
    <script src="js/sb-admin-2.min.js"></script>


    <!-- AGREGANDO CIFRADO DES
    <script src="criptojs/rollups/tripledes.js" type="text/javascript"></script>
    <script src="criptojs/components/mode-ecb-min.js" type="text/javascript"></script>
    <script src="js/utilDes.js" type="text/javascript"></script>
    -->

    <!-- AGREGANDO CIFRADO AES-->
    <script src="criptojs/rollups/aes.js"></script>
    <script src="criptojs/components/mode-ecb.js"></script>
    <script src="js/utilAesECB.js" type="text/javascript"></script>
    

    <!-- DIFFIE HELLMAN (MODIFICAR)-->
    <script>
        console.log('DIFFIE HELLMAN');
        // 1. Solicitar la clave pública de Bob (el servidor) con una petición GET
        $.ajax({
            url: 'diffieHellmanServer',
            type: 'GET',
            dataType: 'json',
            success: async function (bobData) {
                const bobPubKeyBytesBase64 = bobData.bobPubKeyBytes;
                const bobPubKeyBytes = base64ToArrayBuffer(bobPubKeyBytesBase64);

                console.log('Clave pública de Bob recibida:', bobPubKeyBytes);

                // 2. Generar el par de claves para Alice (el cliente) usando ECDH
                const aliceKeyPair = await window.crypto.subtle.generateKey({
                    name: "ECDH",
                    namedCurve: "P-256"  // Usar la curva elíptica P-256
                }, true, ["deriveKey", "deriveBits"]);

                const alicePublicKey = aliceKeyPair.publicKey;
                const alicePrivateKey = aliceKeyPair.privateKey;

                // 3. Exportar la clave pública de Alice para enviarla al servidor
                const alicePubKeyBytes = await window.crypto.subtle.exportKey('spki', alicePublicKey);
                const alicePubKeyBase64 = arrayBufferToBase64(alicePubKeyBytes);

                console.log('Clave pública de Alice generada:', alicePubKeyBase64); //guardando clave generado en  Diffie Hellman

                // 4. Enviar la clave pública de Alice al servidor mediante una petición POST
                $.ajax({
                    url: 'diffieHellmanServer',
                    type: 'POST',
                    data: {
                        'alicePubKeyLength': alicePubKeyBytes.byteLength,
                        'alicePubKeyBytes': alicePubKeyBase64
                    },
                    success: async function (response) {
                        const resultado = response.resultado;
                        console.log('Logrado (Server):', resultado);

                        // 5. Derivar la clave compartida localmente usando la clave privada de Alice y la clave pública de Bob
                        const bobPublicKeyImported = await window.crypto.subtle.importKey(
                            'spki',
                            bobPubKeyBytes,
                            { name: 'ECDH', namedCurve: 'P-256' },
                            true,
                            []
                        );

                        const sharedSecretClient = await window.crypto.subtle.deriveBits({
                            name: 'ECDH',
                            public: bobPublicKeyImported
                        }, alicePrivateKey, 256); // longitud de la clave derivada en bits

                        //cambiar de const a let
                        let sharedSecretClientHex = bufferToHex(sharedSecretClient);


                        //VALIDANDO LONGITUD DE CLAVE COMPARTRIDA SEGUN CIFRADO
                        sharedSecretClientHex = ajustarLongitudClaveAES(sharedSecretClientHex);
                        //sharedSecretClientHex = ajustarLongitudClaveDES(sharedSecretClientHex);

                        console.log('Clave compartida generada en el cliente:', sharedSecretClientHex);

                        //guardando en le localstorage la clave secreta compartida
                        localStorage.setItem('ClaveSecretaCompartidaDH', sharedSecretClientHex);
                    },
                    error: function (error) {
                        console.error('Error al enviar la clave pública de Alice:', error);
                    }
                });
            },
            error: function (error) {
                console.error('Error al obtener la clave pública de Bob:', error);
            }
        });

        function ajustarLongitudClaveDES(sharedSecretClientHex) {
            let claveBytes = new TextEncoder().encode(sharedSecretClientHex);
            // Si la clave es mayor a 8 bytes, truncar a 8 bytes
            if (claveBytes.length > 8) {
                return new TextDecoder().decode(claveBytes.subarray(0, 8)); // Devuelve una cadena de 8 bytes
            }
            // Si la clave es menor a 8 bytes, rellenar con ceros
            let claveAjustada = new Uint8Array(8);
            claveAjustada.set(claveBytes);
            // Rellenar el resto con ceros
            for (let i = claveBytes.length; i < 8; i++) {
                claveAjustada[i] = 0; // Rellenar con ceros
            }
            return new TextDecoder().decode(claveAjustada); // Devuelve una cadena
        }

        function ajustarLongitudClaveAES(sharedSecretClientHex) {
            let claveBytes = new TextEncoder().encode(sharedSecretClientHex);
            // Si la clave es mayor a 16 bytes, truncar a 16 bytes
            if (claveBytes.length > 16) {
                return new TextDecoder().decode(claveBytes.subarray(0, 16)); // Devuelve una cadena de 16 bytes
            }
            // Si la clave es menor a 16 bytes, rellenar con ceros
            let claveAjustada = new Uint8Array(16);
            claveAjustada.set(claveBytes);
            // Rellenar el resto con ceros
            for (let i = claveBytes.length; i < 16; i++) {
                claveAjustada[i] = 0; // Rellenar con ceros
            }
            return new TextDecoder().decode(claveAjustada); // Devuelve una cadena
        }



        // Utilidades para conversión de Base64 a ArrayBuffer y viceversa
        function base64ToArrayBuffer(base64) {
            const binaryString = window.atob(base64);
            const len = binaryString.length;
            const bytes = new Uint8Array(len);
            for (let i = 0; i < len; i++) {
                bytes[i] = binaryString.charCodeAt(i);
            }
            return bytes.buffer;
        }

        function arrayBufferToBase64(buffer) {
            const bytes = new Uint8Array(buffer);
            let binary = '';
            for (let i = 0; i < bytes.byteLength; i++) {
                binary += String.fromCharCode(bytes[i]);
            }
            return window.btoa(binary);
        }

        function bufferToHex(buffer) {
            return Array.prototype.map.call(new Uint8Array(buffer), x => ('00' + x.toString(16)).slice(-2)).join('');
        }

    </script>

    <!-- LOGIN GOOGLE O LOCAL (MODIFICAR)-->
    <script>
        //INICIO SESIÓN GOOGLE 
        window.onload = function () {
            google.accounts.id.initialize({
                client_id: "914158457144-qd1sdimd2ntcmf9krft1rgqafdlsh2bg.apps.googleusercontent.com",
                callback: handleCredentialResponse
            });
            google.accounts.id.prompt();

            // Renderiza el botón de inicio de sesión de Google
            google.accounts.id.renderButton(
                document.querySelector(".g_id_signin"),
                { theme: "outline", size: "large" }
            );

            // Asignar el evento de clic para iniciar sesión manualmente
            document.querySelector(".g_id_signin").onclick = function () {
                google.accounts.id.signIn(); // Iniciar sesión al hacer clic
            };

        };

        function handleCredentialResponse(response) {
            //trayendo el Id token
            let token = response.credential;

            $.ajax({
                url: "authServletGoogle", // La URL de tu servlet
                type: "GET", // Método de la solicitud
                data: { token: token }, // Datos a enviar
                dataType: "json", // Tipo de datos que esperas del servidor
                success: function (resp) {
                    if (resp.resultado === 'OK') {

                        //guardando en localstorage
                        localStorage.setItem('IdToken', token);
                        localStorage.setItem('Tipo', 'google');
                        localStorage.setItem('Usuario', resp.usuario);

                        //mostrando datos de localstorage
                        console.log("ID TOKEN EN LOCALSTORAGE: " + localStorage.getItem('IdToken'));
                        console.log("TIPO TOKEN: " + localStorage.getItem('Tipo'));
                        console.log("USUARIO : " + localStorage.getItem('Usuario'));


                        window.location.href = "principal.html"; // Redirigir si es exitoso
                    } else {
                        alert("Error al iniciar sesión, vuelva a intentarlo");
                    }
                },
                error: function (jqXHR, textStatus, errorThrown) {
                    // Esta función se ejecuta si hay un error en la solicitud
                    console.error("Error en la llamada AJAX: ", textStatus, errorThrown);
                    alert("Error en la comunicación con el servidor.");
                }

            });
        }
        //FIN SESIÓN GOOGLE

        //SESION LOCAL
        $('#btnLogin').click(function () {
            //declarando parámetros
            let login = $('#txtLogin').val();
            let pass = $('#txtPass').val();

            //creando request y cifrando pass
            let request = {
                login: login,
                pass: cifrar(pass, localStorage.getItem('ClaveSecretaCompartidaDH')), //cifrado con clave generado en  Diffie Hellman
                tipo: "local"
            };

            console.log(request);
            //enviando request
            $.ajax({
                url: "authServletLocal", // La URL de tu servlet
                type: "GET", // Método de la solicitud
                data: request, // Datos a enviar
                dataType: "json", // Tipo de datos que esperas del servidor
                success: function (resp) {
                    if (resp.resultado === 'OK') {
                        console.log(resp);
                        //guardando en localstorage
                        localStorage.setItem('IdToken', resp.token);
                        localStorage.setItem('Tipo', 'local');
                        localStorage.setItem('Usuario', login);

                        //mostrando datos de localstorage
                        console.log("ID TOKEN EN LOCALSTORAGE: " + localStorage.getItem('IdToken'));
                        console.log("TIPO TOKEN: " + localStorage.getItem('Tipo'));
                        console.log("USUARIO : " + localStorage.getItem('Usuario'));


                        window.location.href = "principal.html"; // Redirigir si es exitoso
                    } else {
                        alert("Error al iniciar sesión, vuelva a intentarlo");
                    }
                },
                error: function (jqXHR, textStatus, errorThrown) {
                    // Esta función se ejecuta si hay un error en la solicitud
                    console.error("Error en la llamada AJAX: ", textStatus, errorThrown);
                    alert("Error en la comunicación con el servidor.");
                }
            });
        });


        //FIN SESION LOCAL
    </script>

    <!-- LOGIN GOOGLE FACEBOOK (MODIFICAR) -->
    <script>
        // Inicialización de Facebook SDK
        window.fbAsyncInit = function () {
            FB.init({
                appId: '1552402655664137', // Tu App ID de Facebook
                cookie: true, // Habilita cookies para permitir que el servidor acceda a la sesión
                xfbml: true, // Habilita el botón de inicio de sesión
                version: 'v17.0'           // Usa la versión actual de la API
            });

            FB.AppEvents.logPageView(); // Registro de eventos de página
        };

        // Cargar el SDK de Facebook de forma asíncrona
        (function (d, s, id) {
            var js, fjs = d.getElementsByTagName(s)[0];
            if (d.getElementById(id)) {
                return;
            }
            js = d.createElement(s);
            js.id = id;
            js.src = "https://connect.facebook.net/en_US/sdk.js";
            fjs.parentNode.insertBefore(js, fjs);
        }(document, 'script', 'facebook-jssdk'));

        // Manejar el estado de inicio de sesión
        function statusChangeCallback(response) {//RESPONSE DE LA API DE FACEBOOK
            console.log('Estado del login: ', response);
            console.log('TOKEN: ', response.authResponse.accessToken);

            if (response.status === 'connected') {
                // Usuario conectado a Facebook y autorizado para usar la app
                console.log('Conectado a Facebook. Obteniendo información...');
                getFacebookUserData(response); // Obtener datos del usuario

                mandarTokenSerblet(response.authResponse.accessToken);

            } else if (response.status === 'not_authorized') {
                // El usuario está conectado a Facebook pero no a la app
                console.log('Por favor, autoriza la app para continuar.');

            } else {
                // El usuario no ha iniciado sesión en Facebook
                console.log('Por favor, inicia sesión en Facebook.');
            }
        }

        // Revisar el estado de la sesión cuando el usuario hace clic en el botón de login
        function checkLoginState() {
            FB.getLoginStatus(function (response) {
                statusChangeCallback(response);
            });
        }


        function getFacebookUserData() {
            FB.api('/me', { fields: 'id,name,email,first_name,last_name,birthday,gender,location,link,picture' }, function (response) {
                console.log('Información del usuario: ', response);
            });
        }

        function mandarTokenSerblet(token) {

            $.ajax({
                url: "authServletFacebook", // La URL de tu servlet
                type: "GET", // Método de la solicitud
                data: { token: token }, // Datos a enviar
                dataType: "json", // Tipo de datos que esperas del servidor
                success: function (resp) {
                    if (resp.resultado === 'OK') {

                        //guardando en localstorage
                        localStorage.setItem('IdToken', resp.token);
                        localStorage.setItem('Tipo', "facebook");
                        localStorage.setItem('Usuario', resp.usuario);
                        localStorage.setItem('Expiracion', resp.expiracion);


                        //mostrando datos de localstorage
                        console.log("ID TOKEN EN LOCALSTORAGE: " + localStorage.getItem('IdToken'));
                        console.log("TIPO TOKEN: " + localStorage.getItem('Tipo'));
                        console.log("USUARIO : " + localStorage.getItem('Usuario'));

                        let expiracionTimestamp = localStorage.getItem('Expiracion') * 1000; // Convertir a milisegundos
                        let expiracionFecha = new Date(expiracionTimestamp); // Crear objeto Date
                        // Formatear la fecha a una cadena legible
                        let fechaFormateada = expiracionFecha.toLocaleString(); // Formato local
                        console.log("EXPIRACION : " + fechaFormateada);

                        window.location.href = "principal.html"; // Redirigir si es exitoso
                    } else {
                        alert("Error al iniciar sesión, vuelva a intentarlo");
                    }
                },
                error: function (jqXHR, textStatus, errorThrown) {
                    // Esta función se ejecuta si hay un error en la solicitud
                    console.error("Error en la llamada AJAX: ", textStatus, errorThrown);
                    alert("Error en la comunicación con el servidor.");
                }

            });

        }
    </script>

</body>

</html>